---
title: "Beetles mega-analysis"
output:
  html_notebook:
    toc: true
    toc_float: true
---

This is a notebook, updated after the degrees of freedom crisis of May 7-9, 2018, aimed at doing a first-pass analysis of all Beetles data to-date in the same notebook.

```{r global_options, include = F}
knitr::opts_chunk$set(echo=F, warning=F, cache=F, message=F)
```

```{r libraries, include = F}
library(tidyverse)
library(lubridate)
library(psych)
library(rms)
library(dendextend)
```

```{r functions, include = F}
## make function to clean up kid data from US
clean_fun <- function(df, key, ex_final3 = TRUE, ex_addsub = FALSE,
                      cap_exclude = NULL) {
  
  df_clean <- df %>%
    full_join(key) %>%
    filter(!question %in% cap_exclude,
           !is.na(subnum), !is.na(question)) %>%
    mutate(responseNum = recode(response,
                                "no" = 0,
                                "kind of" = 0.5,
                                "yes" = 1),
           responseNum = as.numeric(responseNum)) %>%
    rename(capacity = question) %>%
    distinct(subnum, capacity, responseNum) %>%
    ## mutate(capacity = recode(capacity,
    ##                          "add and subtract numbers" = "addition_subtraction",
    ##                          "choose what to do" = "choice",
    ##                          "feel guilty" = "guilt",
    ##                          "feel happy" = "happiness",
    ##                          "feel love" = "love",
    ##                          "feel pain" = "pain",
    ##                          "feel proud" = "pride",
    ##                          "feel sad" = "sadness",
    ##                          "feel scared" = "fear",
    ##                          "feel shy" = "shyness",
    ##                          "feel sick, like when you feel like you might vomit" = "nausea",
    ##                          "feel tired" = "fatigue",
    ##                          "figure out how to do things" = "figuring_out",
    ##                          "get angry" = "anger",
    ##                          "get hungry" = "hunger",
    ##                          "get hurt feelings" = "hurt_feelings",
    ##                          "hear things" = "hearing",
    ##                          "pray" = "prayer",
    ##                          "remember things" = "memory",
    ##                          "sense temperatures" = "sensing_temp",
    ##                          "sense when things are far away" = "sensing_depth",
    ##                          "smell things" = "smell",
    ##                          "think about things" = "thought")) %>%
    spread(capacity, responseNum) %>%
    remove_rownames() %>%
    column_to_rownames("subnum")
  
  if(ex_final3) {
    df_clean <- df_clean %>% 
      select(-c(`bleed if they touch something sharp`,
                `have minds`, `have souls`))
  }

  if(ex_addsub) {
    df_clean <- df_clean %>% 
      select(-c(`add and subtract numbers`))
  }
  
  return(df_clean)
  
}

## make function to determine max n_factors, given n_obs variables
max_fact_fun <- function(p) {
  
  s_moments <- function(p) {p*(p+1)/2}
  param_est <- function(p, k) {p*k + p - (k*(k-1)/2)}
  check_ok <- function(p, k) {
    a <- (p-k)^2
    b <- p+k
    return(ifelse(a>b, TRUE, FALSE))
  }
  
  df_check <- data.frame()
  for(i in 1:p){
    df_check[i,"check"] <- check_ok(p,i)
  }
  
  max <- df_check %>% filter(check) %>% nrow()
  return(max)
  
}

## make function to implement factor retention criteria
reten_fact_fun <- function(df, rot) {
  
  max_efa <- fa(df, nfactors = max_fact_fun(ncol(df)), rotate = "none")
  max_vacc <- max_efa$Vaccounted %>%
    data.frame() %>%
    rownames_to_column("stat") %>%
    gather(factor, value, -stat) %>%
    spread(stat, value) %>%
    filter(`SS loadings` > 1, `Proportion Explained` > 0.05)
  n_reten1 <- nrow(max_vacc)
  
  reten_efa <- fa(df, nfactors = n_reten1, rotate = rot)
  reten_loadings <- reten_efa$loadings[] %>%
    data.frame() %>%
    rownames_to_column("mc") %>%
    gather(factor, loading, -mc) %>%
    group_by(mc) %>%
    top_n(1, abs(loading)) %>%
    ungroup()
  n_reten2 <- reten_loadings %>%
    count(factor) %>%
    nrow()
    
  return(n_reten2)

}

## make function to plot heatmap of factor loadings
heatmap_fun <- function(df, n_factors, rot){
  
  # do efa
  efa <- fa(df, nfactors = n_factors, rotate = rot)
  
  # get factor loadings
  loadings <- efa$loadings[] %>%
    fa.sort() %>%
    data.frame() %>%
    rownames_to_column("mc") %>%
    rownames_to_column("order") %>%
    mutate(order = as.numeric(order)) %>%
    gather(factor, loading, -c(mc, order))
  
  # get shared variance explained
  vacc <- efa$Vaccounted %>%
    data.frame() %>%
    rownames_to_column("stat") %>%
    filter(stat == "Proportion Explained") %>%
    gather(factor, prop_var, -stat) %>%
    select(-stat)
  
  # plot it all
  plot <- ggplot(loadings %>% 
                   full_join(vacc) %>%
                   mutate(lab = paste0(factor, " (",
                                       format(100*round(prop_var, 2), 
                                              digits = 2),
                                       "%)")),
                 aes(x = lab, y = reorder(mc, desc(order)), fill = loading, 
                     label = format(round(loading, 2), nsmall = 2))) +
    geom_tile(color = "black") +
    geom_text(size = 3) +
    scale_x_discrete(position = "top") +
    scale_fill_distiller(limits = c(-1, 1), palette = "RdYlBu",
                         guide = guide_colorbar(barheight = 15)) +
    theme_minimal()
  
  return(plot)
  
}

## make function to plot clustering of maximal factor loadings
cluster_fun <- function(df, n_factors, rot){
  
  clust <- fa(df, n_factors, rot)$loadings[] %>%
    data.frame() %>%
    dist() %>%
    hclust()
  
  p <- clust %>%
    as.dendrogram() %>%
    set("labels_col", value = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                              "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", 
                              "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"),
        k = 6) %>%
    set("branches_lwd", 0.5) %>%
    as.ggdend() %>%
    ggplot(horiz = F) +
    geom_hline(yintercept = 2, lty = 2, color = "black") +
    coord_cartesian(ylim = c(-3, max(clust$height)))
  
  return(p)
  
}

## make function to plot congruence across samples
loadings_fun <- function(df, n_factors = reten_fact_fun(df, "oblimin"), 
                         rot = "oblimin", label){
  d_efa <- fa(df, n_factors, rot)$loadings[] %>%
    data.frame() %>%
    rownames_to_column("capacity") %>%
    arrange(capacity) %>%
    column_to_rownames("capacity")
  colnames(d_efa) <- gsub("MR", paste(label, "MR", sep = "_"), colnames(d_efa))
  return(d_efa)
}
```

```{r key, include = F}
question_key <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Templeton Grant/DEVELOPMENTAL TASKS/beetles:dimkid:factors/design/beetles cb.csv")
```

# All 23 capacities

```{r, include = F, warning = FALSE}
# US adults PILOT
d_us_ad_pilot_23 <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Templeton Grant/DEVELOPMENTAL TASKS/beetles:dimkid:factors/analysis/_US pilot/beetles_pilot2_tidy.csv") %>%
  filter(scale == "beetles") %>%
  distinct(subid, question, response) %>%
  filter(!question %in% c("bleed", "mind", "soul")) %>%
  mutate(question = recode(question,
                           "add_subtract" = "add and subtract numbers",
                           "angry" = "get angry",
                           # "bleed" = "bleed when they touch something sharp",
                           "choose" = "choose what to do",
                           "figure_out" = "figure out how to do things",
                           "guilty" = "feel guilty",
                           "happy" = "feel happy",
                           "hear" = "hear things",
                           "hungry" = "get hungry",
                           "hurt_feelings" = "get hurt feelings",
                           "love" = "feel love",
                           # "mind" = "have minds",
                           "pain" = "feel pain",
                           "pray" = "pray", 
                           "proud" = "feel proud",
                           "remember" = "remember things",
                           "sad" = "feel sad",
                           "scared" = "feel scared",
                           "sense_far" = "sense when things are far away",
                           "sense_temp" = "sense temperatures",
                           "shy" = "feel shy",
                           "sick" = "feel sick, like when you feel like you might vomit",
                           "smell" = "smell things",
                           # "soul" = "have souls",
                           "think" = "think about things",
                           "tired" = "feel tired")) %>%
  spread(question, response) %>%
  column_to_rownames("subid")
```

```{r, include = F, warning = FALSE}
## US adults: NOT YET RUN
## US children: NOT YET RUN

## GH adults: NOT YET RUN
## GH children
d_gh_ch_23 <- read.csv("/Users/kweisman/Desktop/TEMP_GHANA/beetles_ghana_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key)

## CH adults: NOT YET RUN
## CH children: NOT YET RUN

## TH adults
d_th_ad_23 <- read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_adults_tidy_2018-05-09.csv") %>% clean_fun(key = question_key)
## TH children
d_th_ch_23 <- read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key)

## VT adults
d_vt_ad_23 <- read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_adults_tidy_2018-05-09.csv") %>% clean_fun(key = question_key)
## VT children
d_vt_ch_23 <- read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key)
```

## US Adults: MTurk pilot

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_us_ad_pilot_23, max_fact_fun(ncol(d_us_ad_pilot_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: US Adults (MTurk Pilot)",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_us_ad_pilot_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: US Adults (MTurk Pilot)",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_us_ad_pilot_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_us_ad_pilot_23, reten_fact_fun(d_us_ad_pilot_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: US Adults (MTurk Pilot)",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_us_ad_pilot_23_parallel <- fa.parallel(d_us_ad_pilot_23)
```

Parallel analysis suggests retaining `r d_us_ad_pilot_23_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_us_ad_pilot_23_bic <- VSS(d_us_ad_pilot_23, n = max_fact_fun(ncol(d_us_ad_pilot_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_us_ad_pilot_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors: See 3-factor solution, above.

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_us_ad_pilot_23, reten_fact_fun(d_us_ad_pilot_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: US Adults (MTurk Pilot)",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_us_ad_pilot_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Templeton Grant/DEVELOPMENTAL TASKS/beetles:dimkid:factors/analysis/_US pilot/beetles_pilot2_tidy.csv") %>%
              filter(scale == "beetles") %>%
              distinct(subid, character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: US Adults (MTurk Pilot)",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## US Adults: not yet run

## US Children: not yet run

## GH Adults: not yet run

## GH Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_gh_ch_23, max_fact_fun(ncol(d_gh_ch_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_gh_ch_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```


### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_gh_ch_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_gh_ch_23, reten_fact_fun(d_gh_ch_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_gh_ch_23_parallel <- fa.parallel(d_gh_ch_23)
```

Parallel analysis suggests retaining `r d_gh_ch_23_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_gh_ch_23_bic <- VSS(d_gh_ch_23, n = max_fact_fun(ncol(d_gh_ch_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_gh_ch_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_gh_ch_23, 2, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_gh_ch_23, reten_fact_fun(d_gh_ch_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_gh_ch_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("ghana", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_GHANA/beetles_ghana_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: GH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## TH Adults

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_th_ad_23, max_fact_fun(ncol(d_th_ad_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_th_ad_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_th_ad_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ad_23, reten_fact_fun(d_th_ad_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_th_ad_23_parallel <- fa.parallel(d_th_ad_23)
```

Parallel analysis suggests retaining `r d_th_ad_23_parallel$nfact` factors: See 4-factor solution, above.

```{r, include = F}
d_th_ad_23_bic <- VSS(d_th_ad_23, n = max_fact_fun(ncol(d_th_ad_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_th_ad_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ad_23, 2, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_th_ad_23, reten_fact_fun(d_th_ad_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_th_ad_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("thailand", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_adults_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: TH Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## TH Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_th_ch_23, max_fact_fun(ncol(d_th_ch_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_th_ch_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_th_ch_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ch_23, reten_fact_fun(d_th_ch_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_th_ch_23_parallel <- fa.parallel(d_th_ch_23)
```

Parallel analysis suggests retaining `r d_th_ch_23_parallel$nfact` factors: See 4-factor solution, above.

```{r, include = F}
d_th_ch_23_bic <- VSS(d_th_ch_23, n = max_fact_fun(ncol(d_th_ch_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_th_ch_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ch_23, 3, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_th_ch_23, reten_fact_fun(d_th_ch_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_th_ch_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("thailand", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: TH Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## CH Adults: not yet run

## CH Children: not yet run

## VT Adults

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_vt_ad_23, max_fact_fun(ncol(d_vt_ad_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: VT Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_vt_ad_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: VT Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_vt_ad_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ad_23, reten_fact_fun(d_vt_ad_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: VT Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_vt_ad_23_parallel <- fa.parallel(d_vt_ad_23)
```

Parallel analysis suggests retaining `r d_vt_ad_23_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_vt_ad_23_bic <- VSS(d_vt_ad_23, n = max_fact_fun(ncol(d_vt_ad_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_vt_ad_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors: See 3-factor solution, above.

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_vt_ad_23, reten_fact_fun(d_vt_ad_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: VT Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_vt_ad_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("vanuatu", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_adults_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  mutate(character = gsub("crickets", "beetles", character),
         character = gsub("beetles", "beetles*", character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles*", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#b15928", "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: VT Adults",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## VT Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_vt_ch_23, max_fact_fun(ncol(d_vt_ch_23)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_vt_ch_23, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_vt_ch_23, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ch_23, reten_fact_fun(d_vt_ch_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_vt_ch_23_parallel <- fa.parallel(d_vt_ch_23)
```

Parallel analysis suggests retaining `r d_vt_ch_23_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_vt_ch_23_bic <- VSS(d_vt_ch_23, n = max_fact_fun(ncol(d_vt_ch_23)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_vt_ch_23_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ch_23, 2, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_vt_ch_23, reten_fact_fun(d_vt_ch_23, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_vt_ch_23, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("vanuatu", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  mutate(character = gsub("crickets", "beetles", character),
         character = gsub("beetles", "beetles*", character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles*", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#b15928", "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: VT Children",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "Factor score")
```


## Congruence across sites and age groups

```{r, fig.width = 5, fig.asp = 1}
cong23 <- fa.congruence(list(
  loadings_fun(d_us_ad_pilot_23, n_factors = 4, label = "us_ad"),
  loadings_fun(d_gh_ch_23, n_factors = 4, label = "gh_ch"),
  loadings_fun(d_th_ad_23, n_factors = 4, label = "th_ad"),
  loadings_fun(d_th_ch_23, n_factors = 4, label = "th_ch"),
  loadings_fun(d_vt_ad_23, n_factors = 4, label = "vt_ad"),
  loadings_fun(d_vt_ch_23, n_factors = 4, label = "vt_ch"))) %>%
  data.frame() %>%
  rownames_to_column("factorA") %>%
  gather(factorB, congruence, -factorA) %>%
  mutate_at(vars(starts_with("factor")),
            funs(factor(., levels = c("us_ad_MR1", "us_ad_MR2", 
                                      "us_ad_MR3", "us_ad_MR4",
                                      "gh_ch_MR1", "gh_ch_MR2",
                                      "gh_ch_MR3", "gh_ch_MR4",
                                      "th_ad_MR1", "th_ad_MR2",
                                      "th_ad_MR3", "th_ad_MR4",
                                      "th_ch_MR1", "th_ch_MR2",
                                      "th_ch_MR3", "th_ch_MR4",
                                      "vt_ad_MR1", "vt_ad_MR2",
                                      "vt_ad_MR3", "vt_ad_MR4",
                                      "vt_ch_MR1", "vt_ch_MR2",
                                      "vt_ch_MR3", "vt_ch_MR4"))))

ggplot(cong23, aes(x = factorA, y = factorB,
           fill = congruence, label = round(congruence, 2))) +
  geom_tile(color = "black") +
  geom_text(size = 2) +
  geom_hline(yintercept = 0.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 4.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 8.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 12.5, lty = 2, size = 0.5) +
  geom_hline(yintercept = 16.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 20.5, lty = 2, size = 0.5) +
  geom_hline(yintercept = 24.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 0.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 4.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 8.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 12.5, lty = 2, size = 0.5) +
  geom_vline(xintercept = 16.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 20.5, lty = 2, size = 0.5) +
  geom_vline(xintercept = 24.5, lty = 1, size = 0.5) +
  scale_fill_distiller(palette = "RdGy", limits = c(-1, 1),
                       guide = guide_colorbar(barheight = 30)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "Congruence between 4-factor solutions across samples",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```

```{r, fig.width = 4, fig.asp = 0.67, include = F}
loadings_23 <- data.frame(
  loadings_fun(d_us_ad_pilot_23, n_factors = 4, label = "us_ad"),
          loadings_fun(d_gh_ch_23, n_factors = 4, label = "gh_ch"),
          loadings_fun(d_th_ad_23, n_factors = 4, label = "th_ad"),
          loadings_fun(d_th_ch_23, n_factors = 4, label = "th_ch"),
          loadings_fun(d_vt_ad_23, n_factors = 4, label = "vt_ad"),
          loadings_fun(d_vt_ch_23, n_factors = 4, label = "vt_ch")) %>%
  rename("us_ad_BODY" = us_ad_MR1, "us_ad_HEART" = us_ad_MR2,
         "us_ad_MIND" = us_ad_MR3, "us_ad_anger" = us_ad_MR4,
         "gh_ch_BODYHEART" = gh_ch_MR1, "gh_ch_MINDHEART" = gh_ch_MR2,
         "gh_ch_addsubtract" = gh_ch_MR3, "gh_ch_none" = gh_ch_MR4,
         "th_ad_HEART" = th_ad_MR1, "th_ad_BODY1" = th_ad_MR2,
         "th_ad_MIND" = th_ad_MR3, "th_ad_BODY2" = th_ad_MR4,
         "th_ch_BODY" = th_ch_MR1, "th_ch_MIND" = th_ch_MR2,
         "th_ch_HEART1" = th_ch_MR3, "th_ch_HEART2" = th_ch_MR4,
         "vt_ad_BODY" = vt_ad_MR1, "vt_ad_HEART" = vt_ad_MR2,
         "vt_ad_MIND1" = vt_ad_MR3, "vt_ad_MIND2" = vt_ad_MR4,
         "vt_ch_BODY" = vt_ch_MR1, "vt_ch_MIND" = vt_ch_MR2,
         "vt_ch_HEART" = vt_ch_MR3, "vt_ch_none" = vt_ch_MR4)

# do cluster analysis on factor loadings
loadings_23 %>%
  t() %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  set("labels_col", value = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                              "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", 
                              "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"),
      k = 6) %>%
  set("branches_lwd", 0.5) %>%
  as.ggdend() %>%
  ggplot(horiz = F) +
  # geom_hline(yintercept = 2, lty = 2, color = "black") +
  coord_cartesian(ylim = c(-2, 3)) +
  labs(title = "Hierarchical clustering of factors: All samples",
       subtitle = "Including all 23 capacities; after oblimin rotation")

# do factor analysis on factor loadings
heatmap_fun(loadings_23, reten_fact_fun(loadings_23, "oblimin"), "oblimin")
# fa.parallel(loadings_23)
heatmap_fun(loadings_23, 3, "oblimin")

# do cluster analysis on factor loadings after factor analysis
fa(loadings_23, reten_fact_fun(loadings_23, "oblimin"), "oblimin")$loadings[] %>%
  data.frame() %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  set("labels_col", value = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                              "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", 
                              "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"),
      k = 6) %>%
  set("branches_lwd", 0.5) %>%
  as.ggdend() %>%
  ggplot(horiz = F) +
  # geom_hline(yintercept = 2, lty = 2, color = "black") +
  coord_cartesian(ylim = c(-2, 2)) +
  labs(title = "Hierarchical clustering of factors: All samples",
       subtitle = "Including all 23 capacities; after oblimin rotation")
```

## Master EFA

```{r, fig.width = 4, fig.asp = 1}
d_all_23 <- d_us_ad_pilot_23 %>%
  bind_rows(d_gh_ch_23) %>%
  bind_rows(d_th_ad_23) %>%
  bind_rows(d_th_ch_23) %>%
  bind_rows(d_vt_ad_23) %>%
  bind_rows(d_vt_ch_23)

heatmap_fun(d_all_23, reten_fact_fun(d_all_23, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: All samples",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")

# fa.parallel(d_all_23)

heatmap_fun(d_all_23, 4, "oblimin") +
  labs(title = "Factor loadings, parallel analysis & minimizing BIC: All samples",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")

# VSS(d_all_23)

heatmap_fun(d_all_23, 3, "oblimin") +
  labs(title = "Factor loadings, 3-factor solution: All samples",
       subtitle = "Including all 23 capacities; after oblimin rotation",
       x = "", y = "", fill = "")
```


# Excluding "add and subtract numbers"

```{r, include = F, warning = FALSE}
d_us_ad_pilot_22 <- d_us_ad_pilot_23 %>% select(-`add and subtract numbers`)
```

```{r, include = F, warning = FALSE}
## US adults: NOT YET RUN
## US children: NOT YET RUN

## GH adults: NOT YET RUN
## GH children
d_gh_ch_22 <- read.csv("/Users/kweisman/Desktop/TEMP_GHANA/beetles_ghana_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key, ex_addsub = TRUE)

## CH adults: NOT YET RUN
## CH children: NOT YET RUN

## TH adults
d_th_ad_22 <- read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_adults_tidy_2018-05-09.csv") %>% clean_fun(key = question_key, ex_addsub = TRUE)
## TH children
d_th_ch_22 <- read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key, ex_addsub = TRUE)

## VT adults
d_vt_ad_22 <- read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_adults_tidy_2018-05-09.csv") %>% clean_fun(key = question_key, ex_addsub = TRUE)
## VT children
d_vt_ch_22 <- read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_children_tidy_2018-05-09.csv") %>% clean_fun(key = question_key, ex_addsub = TRUE)
```

## US Adults: MTurk pilot

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_us_ad_pilot_22, max_fact_fun(ncol(d_us_ad_pilot_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: US Adults (MTurk Pilot)",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_us_ad_pilot_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: US Adults (MTurk Pilot)",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_us_ad_pilot_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_us_ad_pilot_22, reten_fact_fun(d_us_ad_pilot_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: US Adults (MTurk Pilot)",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_us_ad_pilot_22_parallel <- fa.parallel(d_us_ad_pilot_22)
```

Parallel analysis suggests retaining `r d_us_ad_pilot_22_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_us_ad_pilot_22_bic <- VSS(d_us_ad_pilot_22, n = max_fact_fun(ncol(d_us_ad_pilot_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_us_ad_pilot_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors: See 3-factor solution, above.

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_us_ad_pilot_22, reten_fact_fun(d_us_ad_pilot_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: US Adults (MTurk Pilot)",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_us_ad_pilot_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Templeton Grant/DEVELOPMENTAL TASKS/beetles:dimkid:factors/analysis/_US pilot/beetles_pilot2_tidy.csv") %>%
              filter(scale == "beetles") %>%
              distinct(subid, character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: US Adults (MTurk Pilot)",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```


## US Adults: not yet run

## US Children: not yet run

## GH Adults: not yet run

## GH Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_gh_ch_22, max_fact_fun(ncol(d_gh_ch_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: GH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_gh_ch_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: GH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_gh_ch_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_gh_ch_22, reten_fact_fun(d_gh_ch_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: GH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_gh_ch_22_parallel <- fa.parallel(d_gh_ch_22)
```

Parallel analysis suggests retaining `r d_gh_ch_22_parallel$nfact` factors: See 2-factor solution, above.

```{r, include = F}
d_gh_ch_22_bic <- VSS(d_gh_ch_22, n = max_fact_fun(ncol(d_gh_ch_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_gh_ch_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors: See 2-factor solution, above.

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_gh_ch_22, reten_fact_fun(d_gh_ch_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: GH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_gh_ch_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("ghana", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_GHANA/beetles_ghana_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: GH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```


## TH Adults

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_th_ad_22, max_fact_fun(ncol(d_th_ad_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_th_ad_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_th_ad_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ad_22, reten_fact_fun(d_th_ad_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_th_ad_22_parallel <- fa.parallel(d_th_ad_22)
```

Parallel analysis suggests retaining `r d_th_ad_22_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_th_ad_22_bic <- VSS(d_th_ad_22, n = max_fact_fun(ncol(d_th_ad_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_th_ad_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ad_22, 2, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_th_ad_22, reten_fact_fun(d_th_ad_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_th_ad_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("thailand", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_adults_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: TH Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```


## TH Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_th_ch_22, max_fact_fun(ncol(d_th_ch_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_th_ch_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_th_ch_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ch_22, reten_fact_fun(d_th_ch_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_th_ch_22_parallel <- fa.parallel(d_th_ch_22)
```

Parallel analysis suggests retaining `r d_th_ch_22_parallel$nfact` factors: See 4-factor solution, above.

```{r, include = F}
d_th_ch_22_bic <- VSS(d_th_ch_22, n = max_fact_fun(ncol(d_th_ch_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_th_ch_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ch_22, 3, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_th_ch_22, reten_fact_fun(d_th_ch_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_th_ch_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("thailand", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: TH Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```


## CH Adults: not yet run

## CH Children: not yet run

## VT Adults

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_vt_ad_22, max_fact_fun(ncol(d_vt_ad_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_vt_ad_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_vt_ad_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ad_22, reten_fact_fun(d_vt_ad_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_vt_ad_22_parallel <- fa.parallel(d_vt_ad_22)
```

Parallel analysis suggests retaining `r d_vt_ad_22_parallel$nfact` factors: 

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_th_ch_22, 3, "oblimin") +
  labs(title = "Factor loadings, parallel analysis: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

```{r, include = F}
d_vt_ad_22_bic <- VSS(d_vt_ad_22, n = max_fact_fun(ncol(d_vt_ad_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_vt_ad_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors: See 2-factor solution, above.

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_vt_ad_22, reten_fact_fun(d_vt_ad_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_vt_ad_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("vanuatu", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_adults_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  mutate(character = gsub("crickets", "beetles", character),
         character = gsub("beetles", "beetles*", character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles*", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#b15928", "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: VT Adults",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```


## VT Children

### Maximal structure, oblimin rotation

```{r, fig.width = 9, fig.asp = 0.4}
heatmap_fun(d_vt_ch_22, max_fact_fun(ncol(d_vt_ch_22)), "oblimin") +
  labs(title = "Factor loadings, maximal solution: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### 4 factors, oblimin rotation

```{r, fig.width = 4, fig.asp = 0.67}
heatmap_fun(d_vt_ch_22, 4, "oblimin") +
  labs(title = "Factor loadings, 4-factor solution: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Reduced structure, oblimin rotation

Following our usual protocol (eigenvalue > 1, shared variance explained > 5%, dominant for $\geq$ 1 capacity after rotation) suggests retaining `r reten_fact_fun(d_vt_ch_22, "oblimin")` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ch_22, reten_fact_fun(d_vt_ch_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Alternative factor retention methods

```{r, include = F}
d_vt_ch_22_parallel <- fa.parallel(d_vt_ch_22)
```

Parallel analysis suggests retaining `r d_vt_ch_22_parallel$nfact` factors: See 3-factor solution, above.

```{r, include = F}
d_vt_ch_22_bic <- VSS(d_vt_ch_22, n = max_fact_fun(ncol(d_vt_ch_22)), rotate = "oblimin", plot = F)
```

Minimizing BIC suggests retaining `r d_vt_ch_22_bic$vss.stats %>% rownames_to_column("nfact") %>% filter(BIC == min(BIC)) %>% select(nfact) %>% as.numeric()` factors:

```{r, fig.width = 4, fig.asp = 1}
heatmap_fun(d_vt_ch_22, 2, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Clustering within reduced factor space

```{r, fig.width = 4, fig.asp = 0.67}
cluster_fun(d_vt_ch_22, reten_fact_fun(d_vt_ch_22, "oblimin"), rot = "oblimin") +
  labs(title = "Hierarchical clustering within reduced factor space: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

### Attributions to characters

```{r, fig.width = 3, fig.asp = 0.9}
fa(d_vt_ch_22, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  mutate(subid = paste("vanuatu", subid, sep = "_")) %>%
  gather(factor, score, -subid) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_children_tidy_2018-05-09.csv") %>% distinct(subid, character)) %>%
  filter(!is.na(character)) %>%
  mutate(character = gsub("crickets", "beetles", character),
         character = gsub("beetles", "beetles*", character)) %>%
  group_by(character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles*", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God"))) %>%
  ggplot(aes(x = character, y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_wrap(~ factor) +
  geom_pointrange() +
  scale_color_manual(guide = "none",
                     values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#b15928", "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: VT Children",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```

## Congruence across sites and age groups

```{r, fig.width = 5, fig.asp = 1}
cong22 <- fa.congruence(list(
  loadings_fun(d_us_ad_pilot_22, n_factors = 4, label = "us_ad"),
  loadings_fun(d_gh_ch_22, n_factors = 4, label = "gh_ch"),
  loadings_fun(d_th_ad_22, n_factors = 4, label = "th_ad"),
  loadings_fun(d_th_ch_22, n_factors = 4, label = "th_ch"),
  loadings_fun(d_vt_ad_22, n_factors = 4, label = "vt_ad"),
  loadings_fun(d_vt_ch_22, n_factors = 4, label = "vt_ch"))) %>%
  data.frame() %>%
  rownames_to_column("factorA") %>%
  gather(factorB, congruence, -factorA) %>%
  mutate_at(vars(starts_with("factor")),
            funs(factor(., levels = c("us_ad_MR1", "us_ad_MR2", 
                                      "us_ad_MR3", "us_ad_MR4",
                                      "gh_ch_MR1", "gh_ch_MR2",
                                      "gh_ch_MR3", "gh_ch_MR4",
                                      "th_ad_MR1", "th_ad_MR2",
                                      "th_ad_MR3", "th_ad_MR4",
                                      "th_ch_MR1", "th_ch_MR2",
                                      "th_ch_MR3", "th_ch_MR4",
                                      "vt_ad_MR1", "vt_ad_MR2",
                                      "vt_ad_MR3", "vt_ad_MR4",
                                      "vt_ch_MR1", "vt_ch_MR2",
                                      "vt_ch_MR3", "vt_ch_MR4"))))

ggplot(cong22, aes(x = factorA, y = factorB,
           fill = congruence, label = round(congruence, 2))) +
  geom_tile(color = "black") +
  geom_text(size = 2) +
  geom_hline(yintercept = 0.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 4.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 8.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 12.5, lty = 2, size = 0.5) +
  geom_hline(yintercept = 16.5, lty = 1, size = 0.5) +
  geom_hline(yintercept = 20.5, lty = 2, size = 0.5) +
  geom_hline(yintercept = 24.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 0.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 4.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 8.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 12.5, lty = 2, size = 0.5) +
  geom_vline(xintercept = 16.5, lty = 1, size = 0.5) +
  geom_vline(xintercept = 20.5, lty = 2, size = 0.5) +
  geom_vline(xintercept = 24.5, lty = 1, size = 0.5) +
  scale_fill_distiller(palette = "RdGy", limits = c(-1, 1),
                       guide = guide_colorbar(barheight = 30)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(title = "Congruence between 4-factor solutions across samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

```{r, include = F}
# label each factor by congruence with us adult factors
cong22_label <- cong22 %>%
  mutate(site = toupper(gsub("_.*$", "", factorA)),
         age = case_when(grepl("_ad_", factorA) ~ "adults",
                         grepl("_ch_", factorA) ~ "children")) %>%
  filter(grepl("us_ad_", factorB), !grepl("MR4", factorB)) %>%
  mutate(us_ad_factor = recode_factor(factorB,
                                      "us_ad_MR1" = "BODY",
                                      "us_ad_MR2" = "HEART",
                                      "us_ad_MR3" = "MIND"),
         us_ad_factor_lab = paste(factorA,
                                  us_ad_factor, 
                                  format(round(congruence, 2), digits = 2), 
                                  sep = "_")) %>%
  group_by(site, age, factorA) %>%
  top_n(1, abs(congruence)) %>%
  ungroup()
```


```{r, fig.width = 4, fig.asp = 0.67, include = F}
loadings_22 <- data.frame(
    loadings_fun(d_us_ad_pilot_22, n_factors = 4, label = "us_ad"),
  loadings_fun(d_gh_ch_22, n_factors = 4, label = "gh_ch"),
  loadings_fun(d_th_ad_22, n_factors = 4, label = "th_ad"),
  loadings_fun(d_th_ch_22, n_factors = 4, label = "th_ch"),
  loadings_fun(d_vt_ad_22, n_factors = 4, label = "vt_ad"),
  loadings_fun(d_vt_ch_22, n_factors = 4, label = "vt_ch")) %>%
  rownames_to_column("capacity") %>%
  gather(factorA, loading, -capacity) %>%
  full_join(cong22_label %>% select(factorA, us_ad_factor_lab)) %>%
  # rename("us_ad_BODY" = us_ad_MR1, "us_ad_HEART" = us_ad_MR2,
  #        "us_ad_MIND" = us_ad_MR3, "us_ad_anger" = us_ad_MR4,
  #        "gh_ch_BODYHEART" = gh_ch_MR1, "gh_ch_MINDHEART" = gh_ch_MR2,
  #        "gh_ch_prayer" = gh_ch_MR3, "gh_ch_shyness" = gh_ch_MR4,
  #        "th_ad_HEART" = th_ad_MR1, "th_ad_BODY" = th_ad_MR2,
  #        "th_ad_MIND" = th_ad_MR3, "th_ad_choice" = th_ad_MR4,
  #        "th_ch_BODY" = th_ch_MR1, "th_ch_MIND" = th_ch_MR2,
  #        "th_ch_HEART1" = th_ch_MR3, "th_ch_HEART2" = th_ch_MR4,
  #        "vt_ad_MIND" = vt_ad_MR1, "vt_ad_BODY" = vt_ad_MR2,
  #        "vt_ad_HEART2" = vt_ad_MR3, "vt_ad_HEART1" = vt_ad_MR4,
  #        "vt_ch_BODY" = vt_ch_MR1, "vt_ch_MIND" = vt_ch_MR2,
  #        "vt_ch_HEART" = vt_ch_MR3, "vt_ch_none" = vt_ch_MR4) %>%
  data.frame() %>%
  select(capacity, us_ad_factor_lab, loading) %>%
  spread(us_ad_factor_lab, loading) %>%
  column_to_rownames("capacity")

# do cluster analysis on factor loadings
loadings_22 %>%
  t() %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  set("labels_col", value = c("#e41a1c", "#377eb8", "#4daf4a", "#984ea3"), 
      k = 4) %>% 
  # set("labels_col", value = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
  #                             "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", 
  #                             "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"),
  #     k = 4) %>%
  set("branches_lwd", 0.5) %>%
  as.ggdend() %>%
  ggplot(horiz = F) +
  # geom_hline(yintercept = 2, lty = 2, color = "black") +
  coord_cartesian(ylim = c(-4, 3)) +
  labs(title = "Hierarchical clustering of factors: All samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")

# do factor analysis on factor loadings
heatmap_fun(loadings_22, reten_fact_fun(loadings_22, "oblimin"), "oblimin")
# fa.parallel(loadings_22)
heatmap_fun(loadings_22, 4, "oblimin")

# do cluster analysis on factor loadings after factor analysis
fa(loadings_22, reten_fact_fun(loadings_22, "oblimin"), "oblimin")$loadings[] %>%
  data.frame() %>%
  dist() %>%
  hclust() %>%
  as.dendrogram() %>%
  set("labels_col", value = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                              "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", 
                              "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"),
      k = 4) %>%
  set("branches_lwd", 0.5) %>%
  as.ggdend() %>%
  ggplot(horiz = F) +
  # geom_hline(yintercept = 2, lty = 2, color = "black") +
  coord_cartesian(ylim = c(-3, 2)) +
  labs(title = "Hierarchical clustering of factors: All samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation")
```

```{r, include = F}
prop_var_fun <- function(df, n_factors, rot){
  vacc <- fa(df, n_factors, rot)$Vaccounted %>%
    data.frame() %>%
    rownames_to_column("stat") %>%
    filter(stat == "Proportion Explained") %>%
    gather(factor, prop_var, -stat)
  
  return(vacc)
}

d_varexp_22 <- bind_rows(
  prop_var_fun(d_us_ad_pilot_22, 4, "oblimin") %>%
    mutate(site = "US", age = "adults"),
  prop_var_fun(d_gh_ch_22, 4, "oblimin") %>%
    mutate(site = "GH", age = "children"),
  prop_var_fun(d_th_ad_22, 4, "oblimin") %>%
    mutate(site = "TH", age = "adults"),
  prop_var_fun(d_th_ch_22, 4, "oblimin") %>%
    mutate(site = "TH", age = "children"),
  prop_var_fun(d_vt_ad_22, 4, "oblimin") %>%
    mutate(site = "VT", age = "adults"),
  prop_var_fun(d_vt_ch_22, 4, "oblimin") %>%
    mutate(site = "VT", age = "children")) %>%
  select(-stat) %>%
  mutate(factor = paste(tolower(site), substr(age, 1, 2), factor, sep = "_"),
         prop_var_round = format(round(prop_var, 2), digits = 2))
```


## Master EFA

```{r, fig.width = 4, fig.asp = 1}
d_all_22 <- d_us_ad_pilot_22 %>%
  bind_rows(d_gh_ch_22) %>%
  bind_rows(d_th_ad_22) %>%
  bind_rows(d_th_ch_22) %>%
  bind_rows(d_vt_ad_22) %>%
  bind_rows(d_vt_ch_22)

heatmap_fun(d_all_22, reten_fact_fun(d_all_22, "oblimin"), "oblimin") +
  labs(title = "Factor loadings, after retention: All samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")

# fa.parallel(d_all_22)

heatmap_fun(d_all_22, 4, "oblimin") +
  labs(title = "Factor loadings, parallel analysis: All samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")

# VSS(d_all_22)

heatmap_fun(d_all_22, 3, "oblimin") +
  labs(title = "Factor loadings, minimizing BIC: All samples",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "", fill = "")
```

### Attributions to characters

```{r}
d_all_22_subid <- d_us_ad_pilot_22 %>%
  rownames_to_column("subid") %>%
  bind_rows(d_gh_ch_22 %>%
              rownames_to_column("subid") %>%
              mutate(subid = paste("gh_ch", subid, sep = "_"))) %>%
  bind_rows(d_th_ad_22 %>%
              rownames_to_column("subid") %>%
              mutate(subid = paste("th_ad", subid, sep = "_"))) %>%
  bind_rows(d_th_ch_22 %>%
              rownames_to_column("subid") %>%
              mutate(subid = paste("th_ch", subid, sep = "_"))) %>%
  bind_rows(d_vt_ad_22 %>%
              rownames_to_column("subid") %>%
              mutate(subid = paste("vt_ad", subid, sep = "_"))) %>%
  bind_rows(d_vt_ch_22 %>%
              rownames_to_column("subid") %>%
              mutate(subid = paste("vt_ch", subid, sep = "_"))) %>%
  column_to_rownames("subid")

subids <- read.csv("/Users/kweisman/Documents/Research (Stanford)/Projects/Templeton Grant/DEVELOPMENTAL TASKS/beetles:dimkid:factors/analysis/_US pilot/beetles_pilot2_tidy.csv") %>% distinct(subid, character) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_GHANA/beetles_ghana_children_tidy_2018-05-09.csv") %>% 
              distinct(subid, character) %>%
              mutate(subid = gsub("ghana", "gh_ch", subid))) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_adults_tidy_2018-05-09.csv") %>% 
              distinct(subid, character) %>%
              mutate(subid = gsub("thailand", "th_ad", subid))) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_THAILAND/beetles_thailand_children_tidy_2018-05-09.csv") %>% 
              distinct(subid, character) %>%
              mutate(subid = gsub("thailand", "th_ch", subid))) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_adults_tidy_2018-05-09.csv") %>% 
              distinct(subid, character) %>%
              mutate(subid = gsub("vanuatu", "vt_ad", subid))) %>%
  full_join(read.csv("/Users/kweisman/Desktop/TEMP_VANUATU/beetles_vanuatu_children_tidy_2018-05-09.csv") %>% 
              distinct(subid, character) %>%
              mutate(subid = gsub("vanuatu", "vt_ch", subid)))
```

```{r, fig.width = 5, fig.asp = 0.7}
fa(d_all_22_subid, 4, "oblimin")$scores[] %>%
  data.frame() %>%
  rownames_to_column("subid") %>%
  gather(factor, score, -subid) %>%
  full_join(subids) %>%
  filter(!is.na(character)) %>%
  mutate(character = gsub("crickets", "beetles", character),
         character = gsub("beetles", "beetles*", character),
         site = toupper(substr(subid, 1, 2)),
         site = ifelse(site == "R_", "US", site),
         age = case_when(grepl("_ad_", subid) ~ "adults",
                         grepl("R_", subid) ~ "adults",
                         grepl("_ch_", subid) ~ "children")) %>%
  filter(!is.na(factor)) %>%
  group_by(site, age, character, factor) %>%
  do(data.frame(rbind(smean.cl.boot(.$score)))) %>%
  ungroup() %>%
  mutate(character = factor(character, 
                            levels = c("cell phones", "rocks", "flowers", 
                                       "beetles*", "chickens", "mice", "dogs", 
                                       "children", "pigs", "ghosts", "God")),
         site = factor(site, levels = c("US", "TH", "VT", "GH")),
         age = factor(age, levels = c("adults", "children"))) %>%
  ggplot(aes(x = character, 
             y = Mean, ymin = Lower, ymax = Upper, 
             color = character)) +
  facet_grid(factor ~ interaction(age, site)) +
  geom_pointrange() +
  scale_color_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c",
                                "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00",
                                "#b15928", "#cab2d6", "#6a3d9a")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = "right",
        panel.border = element_rect(fill = NA, color = "black")) +
  labs(title = "Factor scores, 4-factor solution: All samples to date",
       subtitle = "Excluding 'add and subtract numbers'; after oblimin rotation",
       x = "", y = "Factor score")
```

# Demographics

```{r, include = F}
paste0("US adults (pilot): ", d_us_ad_pilot_23 %>% nrow())
paste0("GH children: ", d_gh_ch_23 %>% nrow())
paste0("TH adults: ", d_th_ad_23 %>% nrow())
paste0("TH adults: ", d_th_ch_23 %>% nrow())
paste0("VT adults: ", d_vt_ad_23 %>% nrow())
paste0("VT adults: ", d_vt_ch_23 %>% nrow())
```
